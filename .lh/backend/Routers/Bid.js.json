{
    "sourceFile": "backend/Routers/Bid.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1768299408892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1768299631080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -77,10 +77,52 @@\n     res.status(500).json({ message: err.message || \"Server error\" });\r\n   }\r\n });\r\n \r\n+// Delete bid - MUST come before the /:bidId/hire route\r\n+router.delete(\"/:bidId\", auth, async (req, res) => {\r\n+  try {\r\n+    const { bidId } = req.params;\r\n \r\n+    console.log(\"=== DELETE BID REQUEST ===\");\r\n+    console.log(\"Bid ID:\", bidId);\r\n+    console.log(\"User ID from auth:\", req.user?.id);\r\n \r\n+    if (!req.user || !req.user.id) {\r\n+      console.log(\"Auth failed - no user in request\");\r\n+      return res.status(401).json({ message: \"Not authenticated\" });\r\n+    }\r\n+\r\n+    // Find bid\r\n+    const bid = await Bid.findById(bidId);\r\n+    if (!bid) {\r\n+      console.log(\"Bid not found:\", bidId);\r\n+      return res.status(404).json({ message: \"Bid not found\" });\r\n+    }\r\n+\r\n+    console.log(\"Bid found - Freelancer ID:\", bid.freelancerId.toString());\r\n+\r\n+    // Only freelancer who created the bid can delete it\r\n+    if (bid.freelancerId.toString() !== req.user.id) {\r\n+      console.log(\"Access denied - User ID mismatch\");\r\n+      console.log(\"Expected freelancer:\", bid.freelancerId.toString());\r\n+      console.log(\"Current user:\", req.user.id);\r\n+      return res.status(403).json({ message: \"Access denied - You can only delete your own bids\" });\r\n+    }\r\n+\r\n+    // Delete bid\r\n+    const deletedBid = await Bid.findByIdAndDelete(bidId);\r\n+    console.log(\"Bid deleted successfully:\", deletedBid);\r\n+\r\n+    res.status(200).json({ message: \"Bid deleted successfully\" });\r\n+  } catch (err) {\r\n+    console.error(\"=== DELETE ERROR ===\");\r\n+    console.error(\"Error:\", err.message);\r\n+    console.error(\"Stack:\", err.stack);\r\n+    res.status(500).json({ message: err.message || \"Server error\" });\r\n+  }\r\n+});\r\n+\r\n router.patch(\"/:bidId/hire\", auth, async (req, res) => {\r\n   try {\r\n     const { bidId } = req.params;\r\n \r\n@@ -160,42 +202,5 @@\n     res.status(500).json({ message: error.message || \"Hiring failed\" });\r\n   }\r\n });\r\n \r\n-// Delete bid\r\n-router.delete(\"/:bidId\", auth, async (req, res) => {\r\n-  try {\r\n-    const { bidId } = req.params;\r\n-\r\n-    console.log(\"Delete request - Bid ID:\", bidId);\r\n-    console.log(\"Current user ID:\", req.user.id);\r\n-\r\n-    // Find bid\r\n-    const bid = await Bid.findById(bidId);\r\n-    if (!bid) {\r\n-      console.log(\"Bid not found:\", bidId);\r\n-      return res.status(404).json({ message: \"Bid not found\" });\r\n-    }\r\n-\r\n-    console.log(\"Bid found:\", bid);\r\n-    console.log(\"Bid freelancer ID:\", bid.freelancerId.toString());\r\n-\r\n-    // Only freelancer who created the bid can delete it\r\n-    if (bid.freelancerId.toString() !== req.user.id) {\r\n-      console.log(\"Access denied - Freelancer ID mismatch\");\r\n-      console.log(\"Expected:\", bid.freelancerId.toString());\r\n-      console.log(\"Got:\", req.user.id);\r\n-      return res.status(403).json({ message: \"Access denied - You can only delete your own bids\" });\r\n-    }\r\n-\r\n-    // Delete bid\r\n-    const deletedBid = await Bid.findByIdAndDelete(bidId);\r\n-    console.log(\"Bid deleted successfully:\", deletedBid);\r\n-\r\n-    res.status(200).json({ message: \"Bid deleted successfully\" });\r\n-  } catch (err) {\r\n-    console.error(\"Delete error:\", err);\r\n-    res.status(500).json({ message: err.message || \"Server error\" });\r\n-  }\r\n-});\r\n-\r\n module.exports = router;\r\n"
                }
            ],
            "date": 1768299408892,
            "name": "Commit-0",
            "content": "// routes/bid.js\r\nconst express = require(\"express\");\r\nconst router = express.Router();\r\nconst Bid = require(\"../Models/Bid\");\r\nconst auth = require(\"../Middlewares/auth\");\r\nconst Gig = require(\"../Models/Gig\");\r\n\r\nconst mongoose = require(\"mongoose\");\r\n\r\nrouter.post(\"/\", auth, async (req, res) => {\r\n  try {\r\n    const { gigId, message, price } = req.body;\r\n\r\n    // console.log(\" Bid submission attempt:\");\r\n    // console.log(\"   Freelancer ID:\", req.user.id);\r\n    // console.log(\"   Gig ID:\", gigId);\r\n    // console.log(\"   Price:\", price);\r\n\r\n    \r\n    const alreadyBid = await Bid.findOne({\r\n      gigId,\r\n      freelancerId: req.user.id\r\n    });\r\n\r\n    if (alreadyBid) {\r\n      return res.status(400).json({ message: \"You already applied\" });\r\n    }\r\n\r\n    const bid = await Bid.create({\r\n      gigId,\r\n      freelancerId: req.user.id, // from cookie (real user)\r\n      message,\r\n      price\r\n    });\r\n\r\n   \r\n    res.status(201).json(bid);\r\n  } catch (err) {\r\n    res.status(500).json({ message: err.message || \"Server error\" });\r\n  }\r\n});\r\n\r\n// my applications\r\nrouter.get(\"/my\", auth, async (req, res) => {\r\n  try {\r\n    const bids = await Bid.find({ freelancerId: req.user.id })\r\n      .populate(\"gigId\", \"title budget status\"); // gig details\r\n\r\n    res.json(bids);\r\n  } catch (err) {\r\n    res.status(500).json({ message: err.message || \"Server error\" });\r\n  }\r\n});\r\n\r\n// get bids for a gig (only owner can see)\r\nrouter.get(\"/gig/:gigId\", auth, async (req, res) => {\r\n  try {\r\n    const { gigId } = req.params;\r\n\r\n    // Find gig\r\n    const gig = await Gig.findById(gigId);\r\n    if (!gig) {\r\n      return res.status(404).json({ message: \"Gig not found\" });\r\n    }\r\n\r\n    // Owner check\r\n    if (gig.ownerId.toString() !== req.user.id) {\r\n      return res.status(403).json({ message: \"Access denied\" });\r\n    }\r\n\r\n    // All bids for this gig\r\n    const bids = await Bid.find({ gigId })\r\n      .populate(\"freelancerId\", \"firstName lastName email\");\r\n\r\n    res.json(bids);\r\n  } catch (err) {\r\n    res.status(500).json({ message: err.message || \"Server error\" });\r\n  }\r\n});\r\n\r\n\r\n\r\nrouter.patch(\"/:bidId/hire\", auth, async (req, res) => {\r\n  try {\r\n    const { bidId } = req.params;\r\n\r\n    //  Get the bid to know which gig it belongs to\r\n    const bid = await Bid.findById(bidId);\r\n    if (!bid) {\r\n      return res.status(404).json({ message: \"Bid not found\" });\r\n    }\r\n\r\n    // Get gig and check ownership (before atomic operation)\r\n    const gig = await Gig.findById(bid.gigId);\r\n    if (!gig) {\r\n      return res.status(404).json({ message: \"Gig not found\" });\r\n    }\r\n\r\n    //  Owner check\r\n    if (gig.ownerId.toString() !== req.user.id) {\r\n      return res.status(403).json({ message: \"Not authorized\" });\r\n    }\r\n\r\n\r\n    const updatedGig = await Gig.findOneAndUpdate(\r\n      { \r\n        _id: bid.gigId,\r\n        status: \"open\"  \r\n      },\r\n      { status: \"assigned\" },\r\n      { new: true }\r\n    );\r\n\r\n    // If updatedGig is null, it means another request already hired for this gig\r\n    if (!updatedGig) {\r\n      return res.status(400).json({ \r\n        message: \"Gig already assigned by someone else\" \r\n      });\r\n    }\r\n\r\n    //  Update selected bid - hired\r\n    bid.status = \"hired\";\r\n    await bid.save();\r\n\r\n    //  Update other bids - rejected\r\n    await Bid.updateMany(\r\n      { gigId: gig._id, _id: { $ne: bid._id } },\r\n      { status: \"rejected\" }\r\n    );\r\n\r\n    //  Emit socket notification to freelancer BEFORE response\r\n    const io = req.app.get(\"io\");\r\n    const onlineUsers = req.app.get(\"onlineUsers\");\r\n\r\n\r\n      \r\n\r\n      const freelancerSocketId = onlineUsers.get(\r\n        bid.freelancerId.toString()\r\n      );\r\n\r\n      console.log(\"Freelancer Socket ID:\", freelancerSocketId);\r\n\r\n      if (freelancerSocketId) {\r\n        io.to(freelancerSocketId).emit(\"hired\", {\r\n          message: `You have been hired for ${gig.title}`\r\n        });\r\n        console.log(\"Notification sent to freelancer\");\r\n      } else {\r\n        console.log(\" Freelancer not online\");\r\n      }\r\n    res.status(200).json({ \r\n      message: \"Freelancer hired successfully\",\r\n      gig: updatedGig,\r\n      bid\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(\"Hire error:\", error);\r\n    res.status(500).json({ message: error.message || \"Hiring failed\" });\r\n  }\r\n});\r\n\r\n// Delete bid\r\nrouter.delete(\"/:bidId\", auth, async (req, res) => {\r\n  try {\r\n    const { bidId } = req.params;\r\n\r\n    console.log(\"Delete request - Bid ID:\", bidId);\r\n    console.log(\"Current user ID:\", req.user.id);\r\n\r\n    // Find bid\r\n    const bid = await Bid.findById(bidId);\r\n    if (!bid) {\r\n      console.log(\"Bid not found:\", bidId);\r\n      return res.status(404).json({ message: \"Bid not found\" });\r\n    }\r\n\r\n    console.log(\"Bid found:\", bid);\r\n    console.log(\"Bid freelancer ID:\", bid.freelancerId.toString());\r\n\r\n    // Only freelancer who created the bid can delete it\r\n    if (bid.freelancerId.toString() !== req.user.id) {\r\n      console.log(\"Access denied - Freelancer ID mismatch\");\r\n      console.log(\"Expected:\", bid.freelancerId.toString());\r\n      console.log(\"Got:\", req.user.id);\r\n      return res.status(403).json({ message: \"Access denied - You can only delete your own bids\" });\r\n    }\r\n\r\n    // Delete bid\r\n    const deletedBid = await Bid.findByIdAndDelete(bidId);\r\n    console.log(\"Bid deleted successfully:\", deletedBid);\r\n\r\n    res.status(200).json({ message: \"Bid deleted successfully\" });\r\n  } catch (err) {\r\n    console.error(\"Delete error:\", err);\r\n    res.status(500).json({ message: err.message || \"Server error\" });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"
        }
    ]
}